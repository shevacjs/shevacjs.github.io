<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>shevacjs home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="all about IT tech, football">
<meta property="og:type" content="website">
<meta property="og:title" content="shevacjs home">
<meta property="og:url" content="http://shevacjs.com/page/2/index.html">
<meta property="og:site_name" content="shevacjs home">
<meta property="og:description" content="all about IT tech, football">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="shevacjs home">
<meta name="twitter:description" content="all about IT tech, football">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="/webfonts/ptserif/main.css" rel='stylesheet' type='text/css'>
  <link href="/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  

</head>

<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-inner" class="inner">
      <a id="main-nav-toggle" class="nav-icon" href="javascript:;"></a>
      <a id="logo" class="logo logo-text" href="/">Shevacjs</a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/categories">Categories</a>
        
          <a class="main-nav-link" href="/tags">Tags</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
          <a class="main-nav-link" href="/atom.xml">Rss</a>
        
      </nav>
      <nav id="sub-nav">
        <div id="search-form-wrap">
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://shevacjs.com"></form>
        </div>
      </nav>
    </div>
  </div>
</header>
    <section id="main" class="outer">
      <article id="post-20180114" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/15/20180114/">weekly of 20180114</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2018/01/15/20180114/" class="article-date">
  <time datetime="2018-01-15T10:28:45.000Z" itemprop="datePublished">2018-01-15</time>
</a>
      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/images/Barcelona_Seaside.jpg" alt="巴塞罗那-海边"></p>
<h3 id="工具技巧"><a href="#工具技巧" class="headerlink" title="工具技巧"></a>工具技巧</h3><ul>
<li><p><a href="https://www.netguru.co/codestories/nginx-tutorial-performance" target="_blank" rel="external">Nginx Tutorial #2: Performance</a> : 关于nginx的介绍文章，这篇重点介绍nginx在性能优化方向做的事情，详细说明了<code>TCP_NODEALY</code>, <code>sendfile</code>等特性, 非常值得学习 </p>
</li>
<li><p><a href="http://servercoder.com/2018/01/10/protobuf-usages/" target="_blank" rel="external">你真的用对protobuf了吗?</a> : Protobuf使用的一些tips</p>
</li>
<li><p><a href="https://zoumiaojiang.com/article/common-web-security/" target="_blank" rel="external">常见 Web 安全攻防总结</a> : 概述的还是非常全面的，包括<code>XSS</code>, <code>CSRF</code>, <code>SQL注入</code></p>
</li>
<li><p><a href="http://facebook.github.io/zstd/" target="_blank" rel="external">Zstandard</a> : “Zstandard is a real-time compression algorithm, providing high compression ratios, It also offers a special mode for small data, called dictionary compression, and can create dictionaries from any sample set”; 后面的特性值得关注</p>
</li>
</ul>
<h3 id="系统设计"><a href="#系统设计" class="headerlink" title="系统设计"></a>系统设计</h3><ul>
<li><p><a href="https://buoyant.io/2017/04/25/whats-a-service-mesh-and-why-do-i-need-one/" target="_blank" rel="external">What’s a service mesh? And why do I need one?</a> : 关于Service Mesh的初步介绍, 去年中旬到现在，是微服务框架的一个很多的概念, 其他可以参考的文章包括<a href="https://istio.io/docs/" target="_blank" rel="external">Istio Document</a>, <a href="https://mp.weixin.qq.com/s?__biz=MjM5MDE0Mjc4MA==&amp;mid=2650998746&amp;idx=1&amp;sn=5ef8234abc6855482db64b581e4e9a9a" target="_blank" rel="external">Service Mesh：下一代微服务？</a>, <a href="https://mp.weixin.qq.com/s?__biz=MzU0MTMyMDg1NQ==&amp;mid=2247483697&amp;idx=1&amp;sn=b5fdd3af4ae352942820cec9280257c3" target="_blank" rel="external">演讲实录 | Service Mesh 时代的选边与站队</a>, <a href="http://dockone.io/article/3022" target="_blank" rel="external">使用Istio治理微服务入门</a>, 感觉和自己之前琐碎梳理的想法很一致, 需要进一步提升对问题和解决方案的归纳总结能力</p>
</li>
<li><p><a href="http://blog.cnbang.net/tech/3531/" target="_blank" rel="external">移动 APP 网络优化概述</a> : 概括性的介绍了移动APP的网络优化思路，包括在弱网情况下的优化策略</p>
</li>
<li><p><a href="https://www.bbsmax.com/A/kmzLLLolzG/" target="_blank" rel="external">TLS协议分析 与 现代加密通信协议设计</a> : 对TLS和密码技术的非常全面的介绍，是之前个人比较想写的一类文章，非常赞，先mark</p>
</li>
<li><p><a href="https://mp.weixin.qq.com/s/6V-zQYwvWuvu3bwtkpaM7w" target="_blank" rel="external">Jeff Dean晒谷歌大脑成绩单，TPU、AutoML、TensorFlow等重大突破</a> : 真心佩服这些无论在高屋建瓴还是技术细节方面，都能考虑周全，推进落地的人员,  其整体战略目标是非常清楚的</p>
</li>
</ul>
<h3 id="琐事小记"><a href="#琐事小记" class="headerlink" title="琐事小记"></a>琐事小记</h3><ul>
<li><a href="https://www.gnu.org/software/gawk/manual/html_node/Reference-to-Elements.html" target="_blank" rel="external">AWK: Referring to an Array Element</a> : 在AWK里面直接使用<code>array[index-expression]</code>是有副作用的，awk内部会自动为此index生成一个emtpy value, 所以判断一个arry的某个index是否存在，最合理的办法是<code>if inx in array</code>，而不是<code>array[index] == &quot;&quot;</code>, 也可以参看<a href="https://www.gnu.org/software/gawk/manual/html_node/Array-Intro.html#Array-Intro" target="_blank" rel="external">AWK:Introduction to Arrays</a></li>
</ul>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><ul>
<li><p><a href="https://mp.weixin.qq.com/s?__biz=MzU1NDA4NjU2MA==&amp;mid=2247487608&amp;idx=3&amp;sn=a6392d5028f0f33bfeebf89baf9e2975" target="_blank" rel="external">Facebook开源端到端自动语音识别系统wav2letter</a> : 其是由Facebook AI 研究团队开源的一款简单而高效的端到端自动语音识别系统, 简单看了文档，感觉安装之类的还是很复杂的</p>
</li>
<li><p><a href="https://www.jiqizhixin.com/articles/2018-01-12-5/" target="_blank" rel="external">前端慌不慌？用深度学习自动生成HTML代码</a> : “如何用前端页面原型生成对应的代码一直是我们关注的问题，本文作者根据 pix2code 等论文构建了一个强大的前端代码生成模型，并详细解释了如何利用 LSTM 与 CNN 将设计原型编写为 HTML 和 CSS 网站”</p>
</li>
<li><p><a href="https://mp.weixin.qq.com/s/Zaqj421ASh0kWGnR2ksHJA" target="_blank" rel="external">由全民吃鸡引发的网游加速学习总结</a> : 关于游戏网络速度优化的说明，可以了解国内的网络拓扑的大概情况</p>
</li>
<li><p><a href="https://www.toutiao.com/a6509770828173804045/" target="_blank" rel="external">10张图，看懂今日头条核心算法技术</a> : 初步介绍今日头条的算法策略, 后续应该还会有更详细的说明</p>
</li>
<li><p><a href="https://www.jianshu.com/p/56acbd66d525" target="_blank" rel="external">天天写业务代码很焦虑，怎么破?</a> : 关于业务和技术开发的常规讨论, “每一层技术实现，都服务于上一层，都以上一层的需求为业务”, 里面对于业务和技术的感受的区分点个人还是很认可的</p>
</li>
<li><p><a href="https://news.ycombinator.com/item?id=16140418" target="_blank" rel="external">iOS 11 Security[pdf]</a> : 苹果的官方文档，关于IOS系统安全性的白皮书, 文档写的非常系统，排版也非常漂亮，值得mark学习</p>
</li>
</ul>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/weekly/">weekly</a></li></ul>

      </footer>
    
  </div>
  
</article>








    
      <article id="post-nginx_1_13_8" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/03/nginx_1_13_8/">nginx 1.13.8 版本说明</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2018/01/03/nginx_1_13_8/" class="article-date">
  <time datetime="2018-01-03T07:17:29.000Z" itemprop="datePublished">2018-01-03</time>
</a>
      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="原始feature说明"><a href="#原始feature说明" class="headerlink" title="原始feature说明"></a>原始feature说明</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">*) Feature: now nginx automatically preserves the CAP_NET_RAW capability</div><div class="line">   in worker processes when using the &quot;transparent&quot; parameter of the</div><div class="line">   &quot;proxy_bind&quot;, &quot;fastcgi_bind&quot;, &quot;memcached_bind&quot;, &quot;scgi_bind&quot;, and</div><div class="line">   &quot;uwsgi_bind&quot; directives.</div><div class="line"></div><div class="line">*) Feature: improved CPU cache line size detection.</div><div class="line">   Thanks to Debayan Ghosh.</div><div class="line"></div><div class="line">*) Feature: new directives in vim syntax highlighting scripts.</div><div class="line">   Thanks to Gena Makhomed.</div><div class="line">.....</div></pre></td></tr></table></figure>
<p>这个我们主要关注<code>feature1</code>和<code>feature2</code>, 即是:</p>
<ul>
<li>对<code>xxx_bind</code>的指令支持<code>CAP_NET_RAW</code>方式</li>
<li>改进对cpu cache line长度的检测</li>
</ul>
<p>我们分布研究这两个问题的背景以及nginx的解决方案</p>
<h3 id="关于xxx-bind"><a href="#关于xxx-bind" class="headerlink" title="关于xxx_bind"></a>关于xxx_bind</h3><p>我们知道存在类似于<code>proxy_bind</code>, <code>fastcgi_bind</code>, <code>memcached_bind</code>之类的nginx指令，其重要是干嘛的呢? 如下是<a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_bind" target="_blank" rel="external">proxy_bind</a>的官方说明(精简):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Syntax:    proxy_bind address [transparent] | off;</div><div class="line">Default:    —</div><div class="line">Context:    http, server, location</div><div class="line"></div><div class="line">Makes outgoing connections to a proxied server originate from the specified local IP address with an optional port (1.11.2). Parameter value can contain variables (1.3.12). The transparent parameter (1.11.0) allows outgoing connections to a proxied server originate from a non-local IP address, for example, from a real IP address of a client:</div><div class="line"></div><div class="line">&gt;&gt;&gt; proxy_bind $remote_addr transparent;</div><div class="line"></div><div class="line">In order for this parameter to work, it is usually necessary to run nginx worker processes with the superuser privileges. On Linux it is not required (1.13.8) as if the transparent parameter is specified, worker processes inherit the CAP_NET_RAW capability from the master process. It is also necessary to configure kernel routing table to intercept network traffic from the proxied server.</div></pre></td></tr></table></figure>
<p>如上, 我们可以总结为<code>proxy_bind</code>实现代理时，和<code>upstream</code>交互，其使用的ip/port是可以调整的，具体包括:</p>
<ol>
<li>绑定本地的其他ip地址 </li>
<li>绑定一个非本地的ip地址 : 这个需要加入<code>transparent</code>参数</li>
</ol>
<p>方法2可以实现真正的透明代理, 不过要具体实现这个功能，需要调整的地方还很多(要保障返回数据报地址是OK的)，具体可以参看nginx的官方blog的文章<a href="https://www.nginx.com/blog/ip-transparency-direct-server-return-nginx-plus-transparent-proxy/" target="_blank" rel="external">IP Transparency and Direct Server Return with NGINX and NGINX Plus as Transparent Proxy</a></p>
<p>回到这次的版本升级的点，可以想像，如果一个机器A想伪造机器B的IP发送请求，是需要一些权限控制的(想想大家之前写的ping程序:) ), 这个传统上面是需要<code>root</code>权限的。显然，这个方案的缺点是，整个nginx都需要以<code>root</code>权限去执行，在安全性和隐私方案是存在风险的。随之，在新的内核和安卓系统强调更多是<a href="http://man7.org/linux/man-pages/man7/capabilities.7.html" target="_blank" rel="external">Capability</a>机制</p>
<p>所以, nginx这次升级的策略就是, 如果存在这个capability，就无需要求root权限了，具体代码如下(添加些许注释): </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_PR_SET_KEEPCAPS &amp;&amp; NGX_HAVE_CAPABILITIES)</span></div><div class="line"><span class="comment">/*</span></div><div class="line">* 使用prctl(PR_SET_KEEPCAPS, xxx)的效果是保证即便切换用户, 其capabilities依旧保留</div><div class="line">*/</div><div class="line">        <span class="keyword">if</span> (ccf-&gt;transparent &amp;&amp; ccf-&gt;user) &#123;</div><div class="line">            <span class="keyword">if</span> (prctl(PR_SET_KEEPCAPS, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) == <span class="number">-1</span>) &#123;</div><div class="line">                ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</div><div class="line">                              <span class="string">"prctl(PR_SET_KEEPCAPS, 1) failed"</span>);</div><div class="line">                <span class="comment">/* fatal */</span></div><div class="line">                <span class="built_in">exit</span>(<span class="number">2</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_CAPABILITIES)</span></div><div class="line">        <span class="keyword">if</span> (ccf-&gt;transparent &amp;&amp; ccf-&gt;user) &#123;</div><div class="line">            <span class="class"><span class="keyword">struct</span> __<span class="title">user_cap_data_struct</span>    <span class="title">data</span>;</span></div><div class="line">            <span class="class"><span class="keyword">struct</span> __<span class="title">user_cap_header_struct</span>  <span class="title">header</span>;</span></div><div class="line"></div><div class="line">            ngx_memzero(&amp;header, <span class="keyword">sizeof</span>(struct __user_cap_header_struct));</div><div class="line">            ngx_memzero(&amp;data, <span class="keyword">sizeof</span>(struct __user_cap_data_struct));</div><div class="line"></div><div class="line">            header.version = _LINUX_CAPABILITY_VERSION_1;</div><div class="line">            data.effective = CAP_TO_MASK(CAP_NET_RAW);</div><div class="line">            data.permitted = data.effective;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line">* 设置用户的CAP_NET_RAW权限</div><div class="line">*/</div><div class="line">            <span class="keyword">if</span> (syscall(SYS_capset, &amp;header, &amp;data) == <span class="number">-1</span>) &#123;</div><div class="line">                ngx_log_error(NGX_LOG_EMERG, cycle-&gt;<span class="built_in">log</span>, ngx_errno,</div><div class="line">                              <span class="string">"capset() failed"</span>);</div><div class="line">                <span class="comment">/* fatal */</span></div><div class="line">                <span class="built_in">exit</span>(<span class="number">2</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h3 id="关于CPU-Cache-Line"><a href="#关于CPU-Cache-Line" class="headerlink" title="关于CPU Cache Line"></a>关于CPU Cache Line</h3><p>关于CPU Cache Line，我们分成三个细化的问题进行研究:</p>
<ol>
<li>CPU Cache 是什么，有什么作用/影响?</li>
<li>Nginx如何实现对CPU Cache Line Size的检测?</li>
<li>Nginx如何应用CPU Cache?</li>
</ol>
<p>下面依次分析</p>
<h4 id="CPU-Cache-作用"><a href="#CPU-Cache-作用" class="headerlink" title="CPU Cache 作用"></a>CPU Cache 作用</h4><p><a href="http://cenalulu.github.io/linux/all-about-cpu-cache/" target="_blank" rel="external">关于CPU Cache – 程序猿需要知道的那些事</a>和<a href="http://www.aristeia.com/TalkNotes/ACCU2011_CPUCaches.pdf" target="_blank" rel="external">CPU Caches and Why You Care</a>这两篇文章对Cpu Cache有非常详细和深刻的说明，可以深入研究之, 简而言之, CPU Cache是一个CPU的硬件Cache，如何合理的利用其特性，可以极大提升程序的性能, 如下是<a href="http://www.aristeia.com/TalkNotes/ACCU2011_CPUCaches.pdf" target="_blank" rel="external">CPU Cache的示意图</a><br>:<br><img src="/images/cpu_cache.png" alt="CPU Cache"></p>
<p>具体地，CPU CACHE是以<code>CPU CACHE LINE</code>为粒度进行组织管理的，不同的cpu其size会有所不同，但一般都是32/64/128位等; 基于次，我们很自然而然的想到，如果要充分利用CPU CACHE，我们的内存地址最好和<code>CPU CACHE LINE SIZE</code>对齐, 这样可以保障较好的cache命中率和cache利用率</p>
<h4 id="Nginx对CPU-CACHE-LINE-SIZE的检测"><a href="#Nginx对CPU-CACHE-LINE-SIZE的检测" class="headerlink" title="Nginx对CPU CACHE LINE SIZE的检测"></a>Nginx对CPU CACHE LINE SIZE的检测</h4><p>这方面，就不详述其推理过程了，直接结论如下(有谬误之处，<a href="mailto:shevacjs@qq.com" target="_blank" rel="external">还请告知</a>) :</p>
<ul>
<li>在<code>configure</code>阶段, 通过获取CPU信息设置<code>NGX_CPU_CACHE_LINE</code>宏变量，在<code>auto/cc/gcc(clang)</code>里面都会有此类的代码，比如:</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">## file: auto/cc/gcc</span></div><div class="line"><span class="keyword">case</span> <span class="variable">$CPU</span> <span class="keyword">in</span></div><div class="line">    pentium)</div><div class="line">        <span class="comment"># optimize for Pentium and Athlon</span></div><div class="line">        CPU_OPT=<span class="string">"-march=pentium"</span></div><div class="line">        NGX_CPU_CACHE_LINE=32</div><div class="line">    ;;</div></pre></td></tr></table></figure>
<ul>
<li>在编译阶段, 验证是否支持<code>sysconf(_SC_LEVEL1_DCACHE_LINESIZE)</code>这个特性，如果支持, 则开启宏<code>NGX_HAVE_LEVEL1_DCACHE_LINESIZE</code>, 大概代码如下:</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">file: ./src/os/unix/ngx_posix_init.c</div><div class="line">如果宏 NGX_HAVE_LEVEL1_DCACHE_LINESIZE 设置，就通过sysconf获取*/</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_HAVE_LEVEL1_DCACHE_LINESIZE)</span></div><div class="line">    size = sysconf(_SC_LEVEL1_DCACHE_LINESIZE);</div><div class="line">    <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</div><div class="line">        ngx_cacheline_size = size;</div><div class="line">    &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure>
<ul>
<li>在运行启动时候获取(编译和运行的机器可能不一样), 所以还需要主动获取，这个里面主要使用<a href="https://en.wikipedia.org/wiki/CPUID#EAX=1:_Processor_Info_and_Feature_Bits" target="_blank" rel="external">cpuid</a>这个指令获取具体的CPU信息, 简要代码如下:</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">file: ./src/os/unix/ngx_posix_init.c 获取信息</div><div class="line">*/</div><div class="line">ngx_cpuinfo();</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line">file: src/core/ngx_cpuinfo.c</div><div class="line">通过汇编指令获取cpu信息，结果存储在 ngx_cacheline_size</div><div class="line">*/</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> ngx_inline <span class="keyword">void</span></span></div><div class="line"><span class="title">ngx_cpuid</span><span class="params">(<span class="keyword">uint32_t</span> i, <span class="keyword">uint32_t</span> *buf)</span></div><div class="line">&#123;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * we could not use %ebx as output parameter if gcc builds PIC,</div><div class="line">     * and we could not save %ebx on stack, because %esp is used,</div><div class="line">     * when the -fomit-frame-pointer optimization is specified.</div><div class="line">     */</div><div class="line"></div><div class="line">    __asm__ (</div><div class="line"></div><div class="line">    <span class="string">"    mov    %%ebx, %%esi;  "</span></div><div class="line"></div><div class="line">    <span class="string">"    cpuid;                "</span></div><div class="line">    <span class="string">"    mov    %%eax, (%1);   "</span></div><div class="line">    <span class="string">"    mov    %%ebx, 4(%1);  "</span></div><div class="line">    <span class="string">"    mov    %%edx, 8(%1);  "</span></div><div class="line">    <span class="string">"    mov    %%ecx, 12(%1); "</span></div><div class="line"></div><div class="line">    <span class="string">"    mov    %%esi, %%ebx;  "</span></div><div class="line"></div><div class="line">    : : <span class="string">"a"</span> (i), <span class="string">"D"</span> (buf) : <span class="string">"ecx"</span>, <span class="string">"edx"</span>, <span class="string">"esi"</span>, <span class="string">"memory"</span> );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="NGINX如何应用CPU-CACHE-LINE"><a href="#NGINX如何应用CPU-CACHE-LINE" class="headerlink" title="NGINX如何应用CPU CACHE LINE"></a>NGINX如何应用CPU CACHE LINE</h4><p>如上，nginx知道<code>cpu cache line size</code>之后，要想办法尽量的把申请的内存地址和<code>cpu cache line size</code>对齐，一个重要的示例就是<code>CRC32</code>的实现，具体如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// file: ./src/core/ngx_crc32.c</span></div><div class="line"></div><div class="line"><span class="keyword">ngx_int_t</span> ngx_crc32_table_init(<span class="keyword">void</span>)</div><div class="line">&#123;</div><div class="line">    <span class="comment">//申请空间，注意多申请了 ngx_cacheline_size</span></div><div class="line">    p = ngx_alloc(<span class="number">16</span> * <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>) + ngx_cacheline_size, ngx_cycle-&gt;<span class="built_in">log</span>);</div><div class="line">    <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</div><div class="line">        <span class="keyword">return</span> NGX_ERROR;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//将内存地址和ngx_cacheline_size对齐，注意，由于多申请了</span></div><div class="line">    <span class="comment">//一些空间，即便内存往前偏移一些，也不会发生内存越界</span></div><div class="line">    p = ngx_align_ptr(p, ngx_cacheline_size);</div><div class="line"></div><div class="line">    <span class="comment">// copy </span></div><div class="line">    ngx_memcpy(p, ngx_crc32_table16, <span class="number">16</span> * <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>));</div><div class="line">    ngx_crc32_table_short = p;</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><ul>
<li><a href="https://www.ibm.com/developerworks/cn/linux/sdk/assemble/inline/" target="_blank" rel="external">Linux 中 x86 的内联汇编</a> : 可以用于了解nginx如何使用<code>cpuid</code>这个指令</li>
<li><a href="http://man7.org/linux/man-pages/man7/capabilities.7.html" target="_blank" rel="external">Capabilities - overview of Linux capabilities</a> :  官方的man手册，对<code>capability</code>有个概述</li>
<li><p><a href="http://rk700.github.io/2016/10/26/linux-capabilities/" target="_blank" rel="external">Linux的capabilities机制</a> : 简单的中文说明，可以作为入门了解</p>
</li>
<li><p><a href="http://www.aristeia.com/TalkNotes/ACCU2011_CPUCaches.pdf" target="_blank" rel="external">CPU Caches and Why You Care</a> : 对CPU CACHE有系统的介绍，其他的概述文章还包括<a href="http://cenalulu.github.io/linux/all-about-cpu-cache/" target="_blank" rel="external">关于CPU Cache – 程序猿需要知道的那些事</a>和<a href="https://coolshell.cn/articles/10249.html" target="_blank" rel="external">7个示例科普CPU CACHE</a></p>
</li>
</ul>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nginx/">nginx</a></li></ul>

      </footer>
    
  </div>
  
</article>








    
      <article id="post-20171210" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/12/20171210/">weekly of 20171210</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2017/12/12/20171210/" class="article-date">
  <time datetime="2017-12-12T07:17:45.000Z" itemprop="datePublished">2017-12-12</time>
</a>
      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/images/seu.jpg" alt="SEU四牌楼-冬日清晨"></p>
<h2 id="工具技巧"><a href="#工具技巧" class="headerlink" title="工具技巧"></a>工具技巧</h2><ul>
<li><p><a href="https://www.haproxy.com/blog/dynamic-configuration-haproxy-runtime-api/" target="_blank" rel="external">Dynamic Configuration with the HAProxy Runtime API</a> : 介绍了<code>HAProxy</code>的动态configure功能，其可以通过一个<code>socat</code>的命令行工具进行交互, 感觉这个设计对于nginx也很有借鉴意义，先mark</p>
</li>
<li><p><a href="https://news.ycombinator.com/item?id=15845114" target="_blank" rel="external">Evolution of <img>: Gif without the GIF</a> : 先mark</p>
</li>
<li><p><a href="https://github.com/Microsoft/ProcDump-for-Linux" target="_blank" rel="external">Microsoft/ProcDump-for-Linux</a> : “ProcDump provides a convenient way for Linux developers to create core dumps of their application based on performance triggers”</p>
</li>
<li><p><a href="https://blog.cloudflare.com/arm-takes-wing/" target="_blank" rel="external">ARM Takes Wing: Qualcomm vs. Intel CPU comparison</a> : 本文具体对比了intel和高通的CPU在服务器市场的性能情况，文章具体分析了在<code>openssl</code>, <code>zlib</code>, <code>go</code>语言, <code>nginx</code>等，在以C语言为基础的组件里面intel的cpu在单核上面优势都比较明显，但是整体的性能(28核vs48核)会弱一些，而go语言arm的处理器没有太多优势; 整体来看, arm后续的服务器的处理器还是很有竞争力的</p>
</li>
</ul>
<h2 id="每周paper"><a href="#每周paper" class="headerlink" title="每周paper"></a>每周paper</h2><ul>
<li><p><a href="https://machinelearning.apple.com/docs/learning-with-privacy-at-scale/appledifferentialprivacysystem.pdf" target="_blank" rel="external">Learning with Privacy at Scale</a> : 苹果介绍了其差分隐私(Differential Privacy)的实践和经验，略长，先mark</p>
</li>
<li><p><a href="https://blog.acolyer.org/2017/11/28/popularity-predictions-of-facebook-videos-for-higher-quality-streaming/" target="_blank" rel="external">Popularity predictions of Facebook videos for higher quality streaming</a> : 预判一些内容的流行度/热点有时候非常有用，比如说视频转H265对CPU等成本非常高, 所以我们如果能够正确预估哪些视频会是热点，并且提前压缩，对带宽和cpu等资源的利用率会有质的提升，具体的预估算法不是特别理解，反正是又引入了一个简单的神经网络模型进行训练，下来可以细看下</p>
</li>
</ul>
<h2 id="系统设计"><a href="#系统设计" class="headerlink" title="系统设计"></a>系统设计</h2><ul>
<li><p><a href="https://blog.cloudflare.com/make-ssl-boring-again/" target="_blank" rel="external">Make SSL boring again</a> : CloudFlare的分享文章，介绍其引入google的开源<a href="https://boringssl.googlesource.com/boringssl/" target="_blank" rel="external">BoringSSL</a>的历程以及收获, 除了对TLS1.3更好的支持以外，还包括<code>private key callback</code>, <code>equal-preference cipher grouping</code>等特性，对于大规模的SSL部署，非常有裨益</p>
</li>
<li><p><a href="https://www.nginx.com/blog/optimizing-web-servers-for-high-throughput-and-low-latency/" target="_blank" rel="external">Optimizing Web Servers for High Throughput and Low Latency</a> : 对于实现一个高性能web server的建议, 从硬件CPU的选择到上层lib库和nginx配置的控制, 讲得非常细，非常系统, 对里面一些优化的理解可以加深对nginx/linux系统的理解，建议多多review</p>
</li>
<li><p><a href="https://mp.weixin.qq.com/s/sDRftJL1xNBR6tQB7S4SIA" target="_blank" rel="external">Aurora Serveless的红与黑</a> : <code>Aurora Serveless</code>是AWS新推出的无服务,类似于mysql的存储解决方案，现在还不大清楚里面的一些实现细节，但是其设计抽象理念值得关注</p>
</li>
</ul>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ul>
<li><p><a href="https://www.gatesnotes.com/About-Bill-Gates/Best-Books-2017" target="_blank" rel="external">5 amazing books I read this year</a> :  Bill Gates推荐2017的几本书，包括<code>The Rise of ISIS by</code>, <code>Turtles All the Way Down</code>, <code>The Color of Law</code> 等, 以上几本书亚马逊基本都有售，可以考虑入手</p>
</li>
<li><p><a href="http://www.visualcapitalist.com/histomap/" target="_blank" rel="external">Histomap: Visualizing the 4,000 Year History of Global Power</a> : 通过可视化的方式展现近4000年历史上各个权利的迭代更替</p>
</li>
<li><p><a href="https://www.feistyduck.com/books/openssl-cookbook/" target="_blank" rel="external">OpenSSL Cookbook</a> : 非常好的关于openssl的工具和实践书籍，对此有兴趣的可以深入看看</p>
</li>
<li><p><a href="https://blog.cloudflare.com/randomness-101-lavarand-in-production/" target="_blank" rel="external">Randomness 101: LavaRand in Production</a> : CloudFlare通过摄像头采集<code>LavaRand</code>的信息，来作为加密随机数的输入变量</p>
</li>
</ul>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/weekly/">weekly</a></li></ul>

      </footer>
    
  </div>
  
</article>








    
      <article id="post-20171126" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/05/20171126/">weekly of 20171126</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2017/12/05/20171126/" class="article-date">
  <time datetime="2017-12-05T03:39:45.000Z" itemprop="datePublished">2017-12-05</time>
</a>
      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/images/shanghai01.jpg" alt="上海外滩"></p>
<h2 id="工具技巧"><a href="#工具技巧" class="headerlink" title="工具技巧"></a>工具技巧</h2><ul>
<li><p><a href="https://aws.amazon.com/cn/blogs/opensource/better-random-number-generation-for-openssl-libc-and-linux-mainline/" target="_blank" rel="external">Better Random Number Generation for OpenSSL, libc, and Linux Mainline</a> : AWS构建了自己的ssl库(<a href="https://aws.amazon.com/cn/blogs/security/introducing-s2n-a-new-open-source-tls-implementation/" target="_blank" rel="external">s2c</a>), 其在随机数生成里面考虑了具体在linux系统下面实线的一个问题，比如fork子进程的时候会完全拷贝内存，导致信息泄露, 引入了在madvise的新的option(<code>MADV_DONTFORK</code>)；还是非常佩服这些公司，能够持续的在这些基础技术上面做投入</p>
</li>
<li><p><a href="https://draveness.me/docker" target="_blank" rel="external">Docker 核心技术与实现原理</a> :  非常不错的docker技术的普及和介绍</p>
</li>
<li><p><a href="https://www.opengarden.com/meshkit.html" target="_blank" rel="external">MeshKit: Mesh networking made easy</a> : 可以支持各设备以<code>P2P</code>的方式交互, 类似于PC上面的P2P，个人觉得随着视频等富媒体的增长，此方向是一个不错的技术选择，但是需要考虑和权衡对用户体验/隐私等方面的保护</p>
</li>
<li><p><a href="https://zhuanlan.zhihu.com/p/31630417" target="_blank" rel="external">拒绝超大coredump - 用backtrace和addr2line搞定异常函数栈</a> : 思路可以总结为自己捕捉段错误的信息, 然后通过<code>backtrace</code>和<code>addr2line</code>打印相应的堆栈信息</p>
</li>
<li><p><a href="http://www.commandlinefu.com/commands/browse/sort-by-votes" target="_blank" rel="external">Commandlinefu</a> : 不少命令还挺有用的，关注<code>curl ifconfig.me</code>, <code>dig +short txt &lt;keyword&gt;.wp.dg.cx</code></p>
</li>
<li><p><a href="https://hackernoon.com/how-ive-captured-all-passwords-trying-to-ssh-into-my-server-d26a2a6263ec" target="_blank" rel="external">How I’ve captured all passwords trying to ssh into my server!</a> : 挺有意思的一个研究, 作者通过重编译<code>openssh</code>使得其可以打印出来登录的用户名和密码, 再基于这些数据做研究，可以发现很多攻击者和登陆者的特征</p>
</li>
</ul>
<h2 id="每周paper"><a href="#每周paper" class="headerlink" title="每周paper"></a>每周paper</h2><h2 id="系统设计"><a href="#系统设计" class="headerlink" title="系统设计"></a>系统设计</h2><ul>
<li><p><a href="https://code.facebook.com/posts/190251048047090/myrocks-a-space-and-write-optimized-mysql-database/" target="_blank" rel="external">MyRocks: A space- and write-optimized MySQL database</a> : <code>MyRocks</code>是基于<code>RocksDB</code>封装的mysql存储引擎,  对存储空间和写优化上面做了大幅的提升, 可以了解下，另外也可以参看<a href="https://code.facebook.com/posts/1478526992216557/migrating-a-database-from-innodb-to-myrocks/" target="_blank" rel="external">Migrating a database from InnoDB to MyRocks</a> 了解他们迁移到Innodb的具体过程</p>
</li>
<li><p><a href="https://weibo.com/ttarticle/p/show?id=2309404179898175459305" target="_blank" rel="external">企业大规模部署机器学习模型的困境</a> : 通过类似于<code>FAAS</code>的方式，提供人工智能相关的服务，可以让其他更多专注于策略的迭代和开发</p>
</li>
</ul>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ul>
<li><p><a href="https://developers.googleblog.com/2017/09/introducing-tensorflow-datasets.html" target="_blank" rel="external">Introduction to TensorFlow Datasets and Estimators</a> : 关于tensorflow的教程，先收藏mark</p>
</li>
<li><p><a href="https://leastauthority.com/blog/mixnet-intro/" target="_blank" rel="external">Introduction to Mix Networks and Anonymous Communication Networks</a> : 对于混杂网络和匿名通信的系统性介绍, 简单扫了一眼，感觉是非常系统性的文章，先收藏mark</p>
</li>
<li><p><a href="https://cs007.blog/" target="_blank" rel="external">Stanford CS007: Personal Finance For Engineers</a> : 斯坦福的教程，一些对于工程师财务管理的建议和指导，现在的材料多为PPT, 先mark收藏</p>
</li>
<li><p><a href="https://weibo.com/ttarticle/p/show?id=2309404179321597125139" target="_blank" rel="external">【深度长文】为什么微博不像微信一样设计得简洁？</a> : 对产品的思考和分析</p>
</li>
<li><p><a href="https://rafalcieslak.wordpress.com/2013/04/02/dynamic-linker-tricks-using-ld_preload-to-cheat-inject-features-and-investigate-programs/" target="_blank" rel="external">Dynamic linker tricks: Using LD_PRELOAD to cheat, inject features and investigate programs</a> : 我们知道系统在搜索动态链接库的时候会优先加载<code>LD_PRELOAD</code>里面的so, 通过着特性，如果我们构造合适威胁的so，可能对程序的行为有着重大影响，比如随机数生成等</p>
</li>
</ul>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/weekly/">weekly</a></li></ul>

      </footer>
    
  </div>
  
</article>








    
      <article id="post-20171119" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/24/20171119/">weekly of 20171119</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2017/11/24/20171119/" class="article-date">
  <time datetime="2017-11-24T08:47:45.000Z" itemprop="datePublished">2017-11-24</time>
</a>
      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/images/austria02.jpg" alt="奥地利一景"></p>
<h2 id="新鲜事"><a href="#新鲜事" class="headerlink" title="新鲜事"></a>新鲜事</h2><ul>
<li><a href="https://github.com/blog/2470-introducing-security-alerts-on-github" target="_blank" rel="external">Introducing security alerts on GitHub</a> : Github支持对于Js或者ruby项目的依赖的安全问题进行警告, 值得关注的是，github通过<code>gemfile</code>和<code>package.json</code>自动解析<a href="https://help.github.com/articles/listing-the-packages-that-a-repository-depends-on/" target="_blank" rel="external">分析依赖</a>, 其次通过<a href="https://cve.mitre.org/" target="_blank" rel="external">CVE IDs</a>对于具体的安全问题进行分析，深入分析这个里面技术/规范需要投入较大的支持, 但是对社区其实是非常好的帮助</li>
</ul>
<h2 id="工具技巧"><a href="#工具技巧" class="headerlink" title="工具技巧"></a>工具技巧</h2><ul>
<li><p><a href="https://tomassetti.me/guide-natural-language-processing/" target="_blank" rel="external">What can you use Natural Language Processing for?</a> : 非常好的NLP工具的入门和大量的材料，先mark</p>
</li>
<li><p><a href="http://abau.org/hannah" target="_blank" rel="external">Hannah – a DSL for parsing and generating files and network traces</a> : 挺好玩的一个工具，通过<code>DSL</code>的方式来定义如何解析和生成数据</p>
</li>
<li><p><a href="https://mp.weixin.qq.com/s/U0311_AiGkIEtyuO9Uh1Rw" target="_blank" rel="external">HTTP/2之服务器推送(Server Push)最佳实践</a> : 具体介绍了如何在合适的业务场景采用server push, 还是比较接地气的</p>
</li>
</ul>
<h2 id="每周paper"><a href="#每周paper" class="headerlink" title="每周paper"></a>每周paper</h2><h2 id="系统设计"><a href="#系统设计" class="headerlink" title="系统设计"></a>系统设计</h2><ul>
<li><a href="http://shevacjs.com/2017/11/21/simple_rank_algo/">简单排序算法概述</a> : 关于hacker news和reddit的简单排序算法的介绍, 可以了解下</li>
</ul>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ul>
<li><p><a href="https://github.com/laoqiren/mlhelper" target="_blank" rel="external">mlhelper: Algorithms and utils for Machine Learning in JavaScript</a> : 一个基于Js的机器学习lib, 可以放在前端做一些简单的机器学习支持，但是google已经开发了一些基于端的机器学习能力组件, 比如<a href="https://deeplearnjs.org/" target="_blank" rel="external">deeplearnjs</a></p>
</li>
<li><p><a href="https://github.com/jacobdufault/cquery/#cquery" target="_blank" rel="external">jacobdufault/cquery</a> : “Low-latency vscode language server for large C++ code-bases, powered by libclang”, cquery implements almost the entire <a href="https://github.com/Microsoft/language-server-protocol" target="_blank" rel="external">language server protocol</a> and provides some extra features to boost; 也有VS的扩展, 可以关注；不过没有其他语言的支持, 先mark</p>
</li>
<li><p><a href="https://time.geekbang.org/column/article/961" target="_blank" rel="external">GitHub上的五大开源机器学习项目</a> : 包括<code>tensorflow</code>, <code>scikit-learn</code>, <code>PredictionIO</code>, <code>Swift AI</code> 和 <code>GoLearn</code>, 后三者分别是<code>scala</code>, <code>swift</code>和<code>go</code>语言的学习库</p>
</li>
<li><p><a href="https://weibo.com/ttarticle/p/show?id=2309404173389983009423" target="_blank" rel="external">细思极恐的YouTube可跳过广告</a> : 文章具体分析了<code>Youtube</code>可跳过广告背后的产品逻辑和商业化策略, 个人还是比较认同的；任何产品都需要找个一个用户体验和商业化的一个折衷点</p>
</li>
<li><p><a href="https://weibo.com/ttarticle/p/show?id=2309404177368133588050" target="_blank" rel="external">10家将机器学习玩出新花样的公司</a> : 具体介绍不用公司在AI在业务线的落地, 个人感觉可以关注<code>Yelp</code>, <code>Pinterest</code>等</p>
</li>
<li><p><a href="https://lagunita.stanford.edu/courses/Engineering/Compilers/Fall2014/about" target="_blank" rel="external">Stanford: Compliers</a> : 斯坦福的关于编译器的课程，想学编译原理的同学可以看看，每个人程序员心中应该都有写一个自己的编译器的一个梦想</p>
</li>
</ul>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/weekly/">weekly</a></li></ul>

      </footer>
    
  </div>
  
</article>








    
      <article id="post-simple_rank_algo" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/21/simple_rank_algo/">简单排序算法概述</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2017/11/21/simple_rank_algo/" class="article-date">
  <time datetime="2017-11-21T12:01:29.000Z" itemprop="datePublished">2017-11-21</time>
</a>
      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>网上有很多这个方面的资料，这里做个简单的总结, 参考资料里面很多写的都很好</p>
</blockquote>
<p>主要介绍两个: Hacker News 和 Reddit</p>
<h3 id="Hacker-News"><a href="#Hacker-News" class="headerlink" title="Hacker News"></a>Hacker News</h3><p>整体算法如下:</p>
<p>$$ score = weight * \frac{(base-1)^{0.8}}{(time + 2)^G}$$</p>
<p>几个关键因子:</p>
<ul>
<li>weigth : 对不同的类别，权重可以自定义</li>
<li>time : 从提交时刻到现在的时间 (以小时计算)</li>
<li>base : 物料的基本信息, 和业务相关，比如点赞数/评论等等</li>
<li>G : 控制时间因子的敏感程度</li>
</ul>
<p>可以理解是和<code>内容质量(base)</code>/<code>内容分类(weight</code>)/<code>内容新鲜度相关</code>的一个排序算法</p>
<p>如下可以分析出G对score的影响(敏感程度) :</p>
<p><img src="/images/hacker_rank.png" alt="敏感程度"></p>
<blockquote>
<p>发现直接采用<code>notebook</code> + <code>pyplot</code> 绘制数学曲线还是非常有效的，建议!</p>
</blockquote>
<h3 id="Reddit"><a href="#Reddit" class="headerlink" title="Reddit"></a>Reddit</h3><p>如下:</p>
<p>$$f(t_s, y, z) = log_{10}z + \frac{y*t_s}{45000}$$</p>
<p>其中:</p>
<ul>
<li>$t_s$ : 发帖时间的时间戳</li>
<li>$y$ : $y \in {-1, 0, 1}$, 且有:</li>
</ul>
<p>$$<br>y = \begin{cases}<br>    1 &amp; \text{if x &gt; 0} \\<br>    0 &amp; \text{if x = 0} \\<br>   -1 &amp; \text{if x &lt; 0}<br>    \end{cases}<br>$$</p>
<ul>
<li>$x$, 其为$U$,$D$之差，前者为正反馈数量(比如点赞/评论)，后者为负反馈数量(比如踩之类的)</li>
</ul>
<p>$$ x = U - D $$</p>
<ul>
<li>而z者为：</li>
</ul>
<p>$$<br>z = \begin{cases}<br>     |x| &amp; \text{if |x| } \geq 1  \\<br>         1 &amp; \text{if |x| &lt; 1 }<br>     \end{cases}<br>$$</p>
<p>从上面公式可以分析:</p>
<ul>
<li><p>发帖时间对score影响较大, 但是和hacker news不一样的是，发帖分数不会降低，不过新增的贴子分数会比较高</p>
</li>
<li><p>由于通过$log_{10}z$ 打平, 前10的投票效果和前100相差不会很大, 而且是算$(U-D)$,所有有争议的文章的分数也不会很高 </p>
</li>
</ul>
<h3 id="分析总结"><a href="#分析总结" class="headerlink" title="分析总结"></a>分析总结</h3><ul>
<li>reddit对时间较为不敏感，较好的文章可以保留更久, hacker news则不一样</li>
<li>实现上面, reddit时间系数不变；所以只需要再文章up/down的时候更新score即可</li>
</ul>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="http://www.cnblogs.com/zhengyun_ustc/archive/2010/12/15/amir.html" target="_blank" rel="external">Hacker News与Reddit的算法比较</a></li>
<li><a href="http://fjdu.github.io/algorithm/2016/11/29/hacker-news-ranking-algorithm.html" target="_blank" rel="external">Hacker News 的排序算法</a></li>
<li><p><a href="https://redditblog.com/2009/10/15/reddits-new-comment-sorting-system/" target="_blank" rel="external">reddit’s new comment sorting system</a></p>
</li>
<li><p><a href="https://moz.com/blog/reddit-stumbleupon-delicious-and-hacker-news-algorithms-exposed" target="_blank" rel="external">Reddit, Stumbleupon, Del.icio.us and Hacker News Algorithms Exposed!</a></p>
</li>
<li><p><a href="https://medium.com/hacking-and-gonzo/how-reddit-ranking-algorithms-work-ef111e33d0d9" target="_blank" rel="external">How Reddit ranking algorithms work</a> : 比较新的文章，分析也比较深入，比较推荐</p>
</li>
</ul>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/misc/">misc</a></li></ul>

      </footer>
    
  </div>
  
</article>








    
      <article id="post-20171112" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/20/20171112/">weekly of 20171112</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2017/11/20/20171112/" class="article-date">
  <time datetime="2017-11-20T08:31:45.000Z" itemprop="datePublished">2017-11-20</time>
</a>
      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>最近略忙, 大部分weekly都延迟了</p>
</blockquote>
<p><img src="/images/milan_church.jpg" alt="米兰大教堂"></p>
<h2 id="工具技巧"><a href="#工具技巧" class="headerlink" title="工具技巧"></a>工具技巧</h2><ul>
<li><p><a href="http://ialloc.org/posts/2017/11/03/ngx-notes-prerequisite/#id2" target="_blank" rel="external">Nginx 源代码笔记 - Prerequisite</a> : 之前推荐过这个博主的文章, 这篇是比较新的介绍nginx核心处理流程, 对于filter等执行顺序也有比较深入的介绍</p>
</li>
<li><p><a href="https://www.ibm.com/developerworks/cn/linux/l-lo-eBPF-history/index.html" target="_blank" rel="external">eBPF 简史</a> : “高屋建瓴深入浅出”, 非常好的<code>eBPF</code>系统性介绍, 对这方面有认识的，可以深入了解下</p>
</li>
</ul>
<h2 id="系统设计"><a href="#系统设计" class="headerlink" title="系统设计"></a>系统设计</h2><ul>
<li><p><a href="https://brandur.org/redis-streams" target="_blank" rel="external">Redis Streams and the Unified Log</a> : 本文主要介绍了redis新的将要支持的<code>streams</code>机制, 其设计功能类似于<code>kafaka</code>, 用于全局统一的日志/事件记录, 作者任务redis对于精细简单任务更为适合，也更容易上手;</p>
</li>
<li><p><a href="https://mp.weixin.qq.com/s?__biz=MzI0MjczMjM2NA==&amp;mid=2247483872&amp;idx=1&amp;sn=db0fbb2bec0d4e68593f1b9bfc20a8b5" target="_blank" rel="external">爱奇艺个性化推荐排序实践</a> : 具体介绍了爱奇艺的推荐架构里面排序层的实践，从最原始的<code>LR</code>, 到现在的多层<code>DNN+GBDT+FM</code>, 如果理解是对技术的不断机制追求的探索</p>
</li>
</ul>
        
          <p class="article-more-link">
            <a href="/2017/11/20/20171112/#more">Read More</a>
          </p>
        
      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/weekly/">weekly</a></li></ul>

      </footer>
    
  </div>
  
</article>








    
      <article id="post-20171105" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/07/20171105/">weekly of 20171105</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2017/11/07/20171105/" class="article-date">
  <time datetime="2017-11-07T08:31:45.000Z" itemprop="datePublished">2017-11-07</time>
</a>
      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/images/Austria1.jpg" alt="奥地利一景-2015"></p>
<h2 id="新鲜事"><a href="#新鲜事" class="headerlink" title="新鲜事"></a>新鲜事</h2><ul>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzA3ODg4MDk0Ng==&amp;mid=2651113865&amp;idx=1&amp;sn=6a2153fc5eb16c7d2c31e05c83dd6e7a" target="_blank" rel="external">重磅消息！Kotlin要支持iOS开发和Web开发</a> : 有个统一的前端开发栈也是非常不错的</li>
</ul>
<h2 id="工具技巧"><a href="#工具技巧" class="headerlink" title="工具技巧"></a>工具技巧</h2><ul>
<li><p><a href="https://paper.seebug.org/423/" target="_blank" rel="external">前端防御从入门到弃坑–CSP变迁</a> : 比较喜欢的文章风格，对CSP的历史缘由，发展历程说的很清楚, 去年paper提出的<code>nonce script</code>和<code>strict-dynamic</code>如今也面临着更多的威胁和挑战</p>
</li>
<li><p><a href="https://qiuzhenyuan.github.io/2017/09/24/%E5%B8%B8%E7%94%A8%E5%AF%86%E7%A0%81%E5%AD%A6%E6%8A%80%E6%9C%AF/" target="_blank" rel="external">常用密码学技术</a> : 对密码学的有比较系统的介绍和梳理，感觉非常适合入门者学习; 如果能加上一些应用就更好了；争取本周自己也补一篇此类的文章</p>
</li>
<li><p><a href="https://www.igvita.com/2012/12/18/deploying-new-image-formats-on-the-web/" target="_blank" rel="external">Deploying WebP via Accept Content Negotiation</a> : 是一篇2013年的文章, 作者(<a href="https://hpbn.co/" target="_blank" rel="external">High Performance Browser Networking</a>书籍的作者) 很详细的介绍了如果通过client/server等多方的联动，可以透明，相对低成本的接入webp格式的图片; 对后续我们要引入新的资源类型有比较好的参考意义, 也可以参考作者另外一篇文章<a href="https://www.igvita.com/2012/12/18/deploying-new-image-formats-on-the-web/" target="_blank" rel="external">Deploying New Image Formats on the Web</a></p>
</li>
<li><p><a href="https://blog.lizzie.io/linux-containers-in-500-loc.html#sec-1" target="_blank" rel="external">Linux containers in 500 lines of code</a> : 本文用一个最小的集合实现vm, 可以加深对linux下面虚拟机机制的理解</p>
</li>
</ul>
        
          <p class="article-more-link">
            <a href="/2017/11/07/20171105/#more">Read More</a>
          </p>
        
      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/weekly/">weekly</a></li></ul>

      </footer>
    
  </div>
  
</article>








    
      <article id="post-20171029" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/02/20171029/">weekly of 20171029</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2017/11/02/20171029/" class="article-date">
  <time datetime="2017-11-02T06:31:45.000Z" itemprop="datePublished">2017-11-02</time>
</a>
      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/images/danshui.jpg" alt="台湾-淡水渔人码头"></p>
<h2 id="新鲜事"><a href="#新鲜事" class="headerlink" title="新鲜事"></a>新鲜事</h2><h2 id="工具技巧"><a href="#工具技巧" class="headerlink" title="工具技巧"></a>工具技巧</h2><ul>
<li><p><a href="https://mp.weixin.qq.com/s/VZMhbha3sjxxNFTcIGYESw" target="_blank" rel="external">No.22 漫谈数据质量监控</a> : 非常有干货的一篇文章, 可以加深</p>
</li>
<li><p><a href="https://github.com/Tencent/tsf" target="_blank" rel="external">Tencent Server Framework</a> : “Tencent Server Framework is a coroutine and Swoole based server framework for fast server deployment which developed by Tencent engineers.”, 先关注下, 看下是否做进一步的落地</p>
</li>
<li><p><a href="https://mp.weixin.qq.com/s/uzvzF2owmw_g5vP-Np7x5w" target="_blank" rel="external">MixPanel －Android 端埋点技术研究</a> : <code>MixPanel</code>是不多数的开源的可视化埋点的NA框架, 可以关注</p>
</li>
</ul>
        
          <p class="article-more-link">
            <a href="/2017/11/02/20171029/#more">Read More</a>
          </p>
        
      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/weekly/">weekly</a></li></ul>

      </footer>
    
  </div>
  
</article>








    
      <article id="post-20171022" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/10/25/20171022/">weekly of 20171022</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2017/10/25/20171022/" class="article-date">
  <time datetime="2017-10-25T02:38:45.000Z" itemprop="datePublished">2017-10-25</time>
</a>
      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/images/xihu.jpg" alt="西湖一景"></p>
<h2 id="新鲜事"><a href="#新鲜事" class="headerlink" title="新鲜事"></a>新鲜事</h2><ul>
<li><p><a href="https://blogs.windows.com/msedgedev/2017/10/18/documenting-web-together-mdn-web-docs/#akYR4ff8rcL8TY9Q.97" target="_blank" rel="external">Documenting the Web together</a> : 微软宣布把W3C的文档都收敛到MDN, 完成web文档的大一统，个人觉得MDN的文档真心不错，有空可以帮忙上去做一些翻译</p>
</li>
<li><p><a href="https://mp.weixin.qq.com/s/3OeVknv8H60OdTPQBKFjaA" target="_blank" rel="external">密钥重载攻击：强制WPA2重用Nonce</a> : 先mark</p>
</li>
</ul>
<h2 id="工具技巧"><a href="#工具技巧" class="headerlink" title="工具技巧"></a>工具技巧</h2><ul>
<li><p><a href="https://news.ycombinator.com/item?id=15491553" target="_blank" rel="external">VIM AFTER 15 YEARS</a> : 作者使用vim整整15年，介绍了一些不错的plugin, 建议包括<a href="https://github.com/junegunn/fzf" target="_blank" rel="external">fzf</a>(命令行形式的finder) 等 </p>
</li>
<li><p><a href="https://meribold.github.io/2017/10/20/survey-of-cpu-caches/#listing-1" target="_blank" rel="external">A Survey of CPU Caches</a> : 对Cpu Cache很形象的解释和图形化的说明</p>
</li>
<li><p><a href="https://github.com/RaRe-Technologies/bounter" target="_blank" rel="external">RaRe-Technologies/bounter</a> : “Efficient Counter that uses a limited (bounded) amount of memory regardless of data size.”, 内部通过<code>HLL</code>，<a href="https://en.wikipedia.org/wiki/Count%E2%80%93min_sketch" target="_blank" rel="external">Count-min Sketch algorithm</a>做近似统计.</p>
</li>
</ul>
        
          <p class="article-more-link">
            <a href="/2017/10/25/20171022/#more">Read More</a>
          </p>
        
      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/weekly/">weekly</a></li></ul>

      </footer>
    
  </div>
  
</article>








    
      <nav id="page-nav">
        <a class="extend prev" rel="prev" href="/">&laquo; 上一页</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/3/">下一页 &raquo;</a>
      </nav>
    </section>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 shevacjs&nbsp;
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, theme by <a href="http://github.com/ppoffice">PPOffice</a>
    </div>
  </div>
</footer>
    
<script>
  var disqus_shortname = 'shevacjs-com';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="/js/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
  </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>