<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>PACæ–‡ä»¶ - shevacjs home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="æ¦‚è¿°PACæ–‡ä»¶(Proxy Auto-Config)å¯ä»¥çº¦å®šæµè§ˆå™¨å¦‚ä½•å»è®¿é—®ä¸€ä¸ªç‰¹å®šçš„ç½‘ç«™ã€‚å…¶åº”è¯¥æ˜¯æœ€ä¸ºå¸¸è§çš„ä»£ç†æŠ€æœ¯ä¹‹ä¸€ï¼Œä»¥å…¶æ–¹ä¾¿ï¼Œç®€æ´ï¼Œçµæ´»æ€§è¢«å¤§éƒ¨åˆ†ä¸»æµç³»ç»Ÿ(æ— è®ºæ˜¯å®‰å“è¿˜æ˜¯IOS)å’Œæµè§ˆå™¨æ‰€æ”¯æŒã€‚æ­£å¥½æœ€è¿‘å¤„ç†äº†ä¸€ä¸ªPACçš„é—®é¢˜ï¼Œæ‰€ä»¥è¿™é‡Œå…·ä½“ä»‹ç»PACç›¸å…³çš„æŠ€æœ¯ï¼ŒåŒ…æ‹¬PACçš„æ–‡ä»¶ç¼–å†™å’ŒPACçš„ä»£ç†æŠ€æœ¯ã€‚ PACæ–‡ä»¶ç¼–å†™å¦‚ä¸Šï¼ŒPACæ˜¯ä¸€ä¸ªç”¨æ¥çº¦å®šæµè§ˆå™¨å¦‚ä½•è®¿é—®ç½‘ç«™çš„é…ç½®æè¿°ã€‚å…¶ç»„ç»‡æ–¹å¼å¦‚ä¸‹: 1">
<meta name="keywords" content="nginx, proxy">
<meta property="og:type" content="article">
<meta property="og:title" content="PACæ–‡ä»¶">
<meta property="og:url" content="http://shevacjs.com/2018/04/21/about_pac/index.html">
<meta property="og:site_name" content="shevacjs home">
<meta property="og:description" content="æ¦‚è¿°PACæ–‡ä»¶(Proxy Auto-Config)å¯ä»¥çº¦å®šæµè§ˆå™¨å¦‚ä½•å»è®¿é—®ä¸€ä¸ªç‰¹å®šçš„ç½‘ç«™ã€‚å…¶åº”è¯¥æ˜¯æœ€ä¸ºå¸¸è§çš„ä»£ç†æŠ€æœ¯ä¹‹ä¸€ï¼Œä»¥å…¶æ–¹ä¾¿ï¼Œç®€æ´ï¼Œçµæ´»æ€§è¢«å¤§éƒ¨åˆ†ä¸»æµç³»ç»Ÿ(æ— è®ºæ˜¯å®‰å“è¿˜æ˜¯IOS)å’Œæµè§ˆå™¨æ‰€æ”¯æŒã€‚æ­£å¥½æœ€è¿‘å¤„ç†äº†ä¸€ä¸ªPACçš„é—®é¢˜ï¼Œæ‰€ä»¥è¿™é‡Œå…·ä½“ä»‹ç»PACç›¸å…³çš„æŠ€æœ¯ï¼ŒåŒ…æ‹¬PACçš„æ–‡ä»¶ç¼–å†™å’ŒPACçš„ä»£ç†æŠ€æœ¯ã€‚ PACæ–‡ä»¶ç¼–å†™å¦‚ä¸Šï¼ŒPACæ˜¯ä¸€ä¸ªç”¨æ¥çº¦å®šæµè§ˆå™¨å¦‚ä½•è®¿é—®ç½‘ç«™çš„é…ç½®æè¿°ã€‚å…¶ç»„ç»‡æ–¹å¼å¦‚ä¸‹: 1">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://shevacjs.com/images/http_tunnel_demo.png">
<meta property="og:updated_time" content="2018-04-21T11:25:48.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="PACæ–‡ä»¶">
<meta name="twitter:description" content="æ¦‚è¿°PACæ–‡ä»¶(Proxy Auto-Config)å¯ä»¥çº¦å®šæµè§ˆå™¨å¦‚ä½•å»è®¿é—®ä¸€ä¸ªç‰¹å®šçš„ç½‘ç«™ã€‚å…¶åº”è¯¥æ˜¯æœ€ä¸ºå¸¸è§çš„ä»£ç†æŠ€æœ¯ä¹‹ä¸€ï¼Œä»¥å…¶æ–¹ä¾¿ï¼Œç®€æ´ï¼Œçµæ´»æ€§è¢«å¤§éƒ¨åˆ†ä¸»æµç³»ç»Ÿ(æ— è®ºæ˜¯å®‰å“è¿˜æ˜¯IOS)å’Œæµè§ˆå™¨æ‰€æ”¯æŒã€‚æ­£å¥½æœ€è¿‘å¤„ç†äº†ä¸€ä¸ªPACçš„é—®é¢˜ï¼Œæ‰€ä»¥è¿™é‡Œå…·ä½“ä»‹ç»PACç›¸å…³çš„æŠ€æœ¯ï¼ŒåŒ…æ‹¬PACçš„æ–‡ä»¶ç¼–å†™å’ŒPACçš„ä»£ç†æŠ€æœ¯ã€‚ PACæ–‡ä»¶ç¼–å†™å¦‚ä¸Šï¼ŒPACæ˜¯ä¸€ä¸ªç”¨æ¥çº¦å®šæµè§ˆå™¨å¦‚ä½•è®¿é—®ç½‘ç«™çš„é…ç½®æè¿°ã€‚å…¶ç»„ç»‡æ–¹å¼å¦‚ä¸‹: 1">
<meta name="twitter:image" content="http://shevacjs.com/images/http_tunnel_demo.png">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="/webfonts/ptserif/main.css" rel='stylesheet' type='text/css'>
  <link href="/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  

</head>

<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-inner" class="inner">
      <a id="main-nav-toggle" class="nav-icon" href="javascript:;"></a>
      <a id="logo" class="logo logo-text" href="/">Shevacjs</a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/categories">Categories</a>
        
          <a class="main-nav-link" href="/tags">Tags</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
          <a class="main-nav-link" href="/atom.xml">Rss</a>
        
      </nav>
      <nav id="sub-nav">
        <div id="search-form-wrap">
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://shevacjs.com"></form>
        </div>
      </nav>
    </div>
  </div>
</header>
    <section id="main" class="outer"><article id="post-about_pac" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      PACæ–‡ä»¶
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2018/04/21/about_pac/" class="article-date">
  <time datetime="2018-04-21T11:18:29.000Z" itemprop="datePublished">2018-04-21</time>
</a>
      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p><a href="https://en.wikipedia.org/wiki/Proxy_auto-config" target="_blank" rel="external">PACæ–‡ä»¶</a>(Proxy Auto-Config)å¯ä»¥çº¦å®šæµè§ˆå™¨å¦‚ä½•å»è®¿é—®ä¸€ä¸ªç‰¹å®šçš„ç½‘ç«™ã€‚å…¶åº”è¯¥æ˜¯æœ€ä¸ºå¸¸è§çš„ä»£ç†æŠ€æœ¯ä¹‹ä¸€ï¼Œä»¥å…¶æ–¹ä¾¿ï¼Œç®€æ´ï¼Œçµæ´»æ€§è¢«å¤§éƒ¨åˆ†ä¸»æµç³»ç»Ÿ(æ— è®ºæ˜¯å®‰å“è¿˜æ˜¯IOS)å’Œæµè§ˆå™¨æ‰€æ”¯æŒã€‚æ­£å¥½æœ€è¿‘å¤„ç†äº†ä¸€ä¸ªPACçš„é—®é¢˜ï¼Œæ‰€ä»¥è¿™é‡Œå…·ä½“ä»‹ç»PACç›¸å…³çš„æŠ€æœ¯ï¼ŒåŒ…æ‹¬PACçš„æ–‡ä»¶ç¼–å†™å’ŒPACçš„ä»£ç†æŠ€æœ¯ã€‚</p>
<h2 id="PACæ–‡ä»¶ç¼–å†™"><a href="#PACæ–‡ä»¶ç¼–å†™" class="headerlink" title="PACæ–‡ä»¶ç¼–å†™"></a>PACæ–‡ä»¶ç¼–å†™</h2><p>å¦‚ä¸Šï¼ŒPACæ˜¯ä¸€ä¸ªç”¨æ¥çº¦å®šæµè§ˆå™¨å¦‚ä½•è®¿é—®ç½‘ç«™çš„é…ç½®æè¿°ã€‚å…¶ç»„ç»‡æ–¹å¼å¦‚ä¸‹:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//code demo from: https://en.wikipedia.org/wiki/Proxy_auto-config</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">FindProxyForURL</span>(<span class="params">url, host</span>) </span>&#123;</div><div class="line">	<span class="comment">// our local URLs from the domains below example.com don't need a proxy:</span></div><div class="line">	<span class="keyword">if</span> (shExpMatch(host, <span class="string">"*.example.com"</span>))</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"DIRECT"</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// URLs within this network are accessed through</span></div><div class="line">	<span class="comment">// port 8080 on fastproxy.example.com:</span></div><div class="line">	<span class="keyword">if</span> (isInNet(host, <span class="string">"10.0.0.0"</span>, <span class="string">"255.255.248.0"</span>))</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"PROXY fastproxy.example.com:8080"</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// All other requests go through port 8080 of proxy.example.com.</span></div><div class="line">	<span class="comment">// should that fail to respond, go directly to the WWW:</span></div><div class="line">	<span class="keyword">return</span> <span class="string">"PROXY proxy.example.com:8080; DIRECT"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶æ ¸å¿ƒæ˜¯æš´éœ²ä¸€ä¸ª<code>FindProxyForURL</code>çš„æ¥å£ï¼Œæ¯æ¬¡æœ‰è¯·æ±‚æ—¶å€™è§¦å‘è¿™ä¸ªå‡½æ•°çš„å›è°ƒï¼Œç”¨äºåˆ¤æ–­å…·ä½“èµ°å“ªç§æ–¹å¼ã€‚ å…·ä½“ç¼–å†™åº”ç”¨æ—¶ï¼Œæœ‰å¦‚ä¸‹å‡ ç‚¹å¯ä»¥æ³¨æ„: </p>
<ul>
<li><p>url/hostä¿¡æ¯ : å¦‚æœè¯·æ±‚æ˜¯<code>https</code>åè®®ï¼Œåˆ™å›è°ƒçš„urlé‡Œé¢å¹¶ä¸ä¼šåŒ…å«å®Œæ•´è·¯å¾„ä¿¡æ¯, ä¹Ÿå°±æ˜¯è¯´å¦‚æœåŸå§‹çš„urlæ˜¯<code>https://xyz.com/abc</code>å›è°ƒç»™<code>FindProxyForURL</code>çš„å‚æ•°ä¹Ÿåªæ˜¯<code>https://xyz.com</code>, è¿™å°±æ„å‘³ç€å¯¹äºhttpsåè®®ï¼Œæˆ‘ä»¬åšä¸äº†urlç²’åº¦çš„ä»£ç†æ§åˆ¶ã€‚å…·ä½“å¯ä»¥å‚è€ƒ<a href="https://github.com/FelisCatus/SwitchyOmega/issues/845" target="_blank" rel="external">Full URLs for HTTPS are no longer provided to PAC scripts</a></p>
</li>
<li><p>è°ƒè¯•é—®é¢˜: PACçš„è°ƒè¯•å’Œæ™®é€šjsçš„è°ƒè¯•æœ‰ç‚¹ä¸ä¸€æ ·ï¼Œå…¶æ˜¯æµè§ˆå™¨è‡ªåŠ¨è§¦å‘è¯·æ±‚çš„ï¼Œæ‰€ä»¥æ–¹æ³•ä¹Ÿæœ‰äº›åŒºåˆ«ã€‚åœ¨Chromeç¯å¢ƒä¸‹ï¼Œå¯ä»¥å»<code>chrome://net-internals/#proxy</code>ç”¨äºé‡æ–°åŠ è½½ä»£ç†è„šæœ¬, åŒæ—¶åœ¨<code>chrome://net-internals/#events</code>å»è¿½è¸ªæ—¥å¿—ï¼Œè¯¦ç»†å¯ä»¥å‚è€ƒ<a href="http://artica-proxy.com/how-to-debug-proxy-pac-with-google-chrome/" target="_blank" rel="external">How to debug proxy.pac with Google Chrome</a></p>
</li>
<li><p>ä»£ç†é—®é¢˜ : æ— è®ºæ˜¯æ€ä¹ˆæ ·çš„ä»£ç†ç­–ç•¥ï¼Œæœ€ç»ˆæˆ‘ä»¬å‡½æ•°éœ€è¦è¿”å›çš„æ˜¯ä¸€ä¸ªä»£ç†æœåŠ¡å™¨, ç°åœ¨ä¸»æµçš„æµè§ˆå™¨ä¸»è¦æ”¯æŒå¦‚ä¸‹ä¸‰ç§è®¿é—®æ–¹å¼:</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>æŒ‡ä»¤ç±»å‹</th>
<th>æ–¹å¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>DIRECT</td>
<td>ç›´æ¥è®¿é—®</td>
</tr>
<tr>
<td>PROXY name:port</td>
<td>é€šè¿‡èµ°ç‰¹å®šåœ°å€çš„httpä»£ç†è®¿é—®</td>
</tr>
<tr>
<td>SOCKS name:port</td>
<td>é€šè¿‡èµ°ç‰¹å®šåœ°å€çš„socksä»£ç†è®¿é—®</td>
</tr>
</tbody>
</table>
<p>å…·ä½“å®ç°çš„æ—¶å€™ä¹Ÿå¯ä»¥é€šè¿‡ä¸åŒåè®®çš„ç»„åˆæˆ–è€…å†—ä½™ï¼Œæ¥æä¾›æ›´é«˜è´¨é‡çš„ä»£ç†æœåŠ¡ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨<code>PROXY name:port</code>çš„æ–¹å¼ï¼Œå…¶æä¾›çš„æ˜¯ä¸€ä¸ªHTTPä»£ç†è®¿é—®çš„èƒ½åŠ›æ”¯æŒ, æˆ‘ä»¬ç°åœ¨ä¸»æµæœ‰http/httpsä¸¤ä¸ªè®¿é—®åè®®ï¼Œå…¶åˆå…·ä½“å¦‚ä½•å»å®ç°ä»£ç†çš„å‘¢ï¼Ÿ</p>
<h2 id="HTTPä»£ç†"><a href="#HTTPä»£ç†" class="headerlink" title="HTTPä»£ç†"></a>HTTPä»£ç†</h2><p>å¦‚ä¸Šï¼Œæˆ‘ä»¬å¸Œæœ›é€šè¿‡ä¸€ä¸ªhttp/httpsæœåŠ¡æ¥æä¾›å¯¹<code>http/https</code>è®¿é—®çš„ä»£ç†ã€‚å¦‚æœæ˜¯ä»…ä»…ä»£ç†<code>HTTP</code>è®¿é—®, å…¶å®ç®—æ¯”è¾ƒç®€å•ã€‚ç”±äºæ˜¯çº¯æ–‡æœ¬ï¼Œä¹Ÿæ— éœ€ä»»ä½•é‰´æƒä¹‹ç±»çš„é€»è¾‘(TLS)ï¼Œåªæœ‰æ­£å¸¸è½¬å‘è¯·æ±‚å³å¯ï¼Œæ™®é€šçš„Nginxå°±èƒ½å®ç°è¯¥åŠŸèƒ½ï¼Œå¯ä»¥å‚è€ƒ<a href="http://shevacjs.com/2015/04/25/nginx_https_proxy/">nginxä¸https:æ­£å‘ä»£ç†æ”¯æŒ</a>(åŸæ–‡æœ‰äº›åœ°æ–¹æœ‰é”™è¯¯ä¹‹å¤„)ã€‚ä½†æ˜¯å¦‚ä½•åŸºäºhttp/httpsçš„æœåŠ¡åš<code>https</code>çš„ä»£ç†å‘¢? å› ä¸ºå¯¹æœåŠ¡å™¨çš„éªŒè¯ç­‰ä¸å¯èƒ½æ˜¯ä»£ç†æœåŠ¡å™¨è‡ªå·±å®ç°çš„ï¼Œæ•…è€Œéœ€è¦ä»£ç†æœåŠ¡å™¨ï¼Œæ ¹æœ¬ä¸Šé¢æ”¯æŒ<code>TLS</code>æˆ–è€…æ›´åº•å±‚çš„æœåŠ¡ä»£ç†ã€‚</p>
<p>è¿™é‡Œéœ€è¦ç”¨åˆ°<a href="https://en.wikipedia.org/wiki/HTTP_tunnel" target="_blank" rel="external">HTTP tunnel</a>æŠ€æœ¯, å…¶ä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªæ­¥éª¤:</p>
<ol>
<li>åå•†é˜¶æ®µ: è¿™ä¸ªæ—¶å€™Clientå‘é€ä¸€ä¸ª<code>CONNECT</code>æŒ‡ä»¤ï¼Œè¿æ¥ä»£ç†æœåŠ¡å™¨ï¼ŒåŒæ—¶å‘Šè¯‰ä»£ç†æœåŠ¡å™¨å…·ä½“è¦è®¿é—®çš„åœ°å€, å…·ä½“å¦‚ä¸‹: </li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">## Clientå‘é€CONNECTæŒ‡ä»¤</div><div class="line">CONNECT example.host.com:22 HTTP/1.1</div><div class="line">Proxy-Authorization: Basic encoded-credentials</div><div class="line"></div><div class="line">## æœåŠ¡å™¨è¿”å›OKï¼Œè¿™è¿™æ¬¡åå•†å®Œæˆï¼Œå…è®¸ä»£ç†</div><div class="line">HTTP/1.1 200 OK</div></pre></td></tr></table></figure>
<p>å¦‚ä¸Šå…¶å®æ˜¯ä¸€ä¸ªæ­£å¸¸æ ‡å‡†çš„HTTPäº¤äº’æµç¨‹</p>
<ol>
<li>ä»£ç†é˜¶æ®µ : ä¸€æ—¦åå•†OKï¼Œä»£ç†æœåŠ¡å™¨è¿™ä¸ªæ—¶å€™æœ‰ç‚¹ç±»ä¼¼äºè¦è½¬å˜æˆ<code>TCPä»£ç†</code>ï¼Œåªåšé€æ˜çš„clientå’Œserverä¹‹é—´çš„æ•°æ®è½¬å‘</li>
</ol>
<p>å¯ä»¥é€šè¿‡ä¸€ä¸ª<code>wireshark</code>çš„è¯·æ±‚åŒ…ï¼Œæ¥è¿›ä¸€æ­¥äº†è§£ç»™è¿‡ç¨‹: </p>
<p><img src="/images/http_tunnel_demo.png" alt="HTTP tunnel"></p>
<h2 id="HTTPä»£ç†å®ç°"><a href="#HTTPä»£ç†å®ç°" class="headerlink" title="HTTPä»£ç†å®ç°"></a>HTTPä»£ç†å®ç°</h2><p>ä»HTTPä»£ç†çš„åè®®æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå¦‚æœä¸€ä¸ªæœåŠ¡å™¨è¦å®ç°HTTP tunnelä»£ç†æ—¢è¦æ”¯æŒHTTPçš„CONNECTæŒ‡ä»¤ï¼Œä¹Ÿå¾—æ”¯æŒ<code>TLS</code>æˆ–è€…<code>TCP</code>çš„ä»£ç†ã€‚è¿™ä¸ªè¦æ±‚å¯¹äºä¹‹å‰çš„nginxæ˜¯å¾ˆéš¾å®ç°çš„ï¼Œæ‰€ä»¥å¤§éƒ¨åˆ†çš„è§£å†³æ–¹æ¡ˆéƒ½æ˜¯åŸºäº<code>squid</code>ï¼Œå½“ç„¶æˆ‘ä»¬çŸ¥é“é€šè¿‡<a href="https://github.com/chobits/ngx_http_proxy_connect_module" target="_blank" rel="external">ngx_http_proxy_connect_module</a>ä¹Ÿèƒ½å®ç°ï¼Œä½†æ˜¯éœ€è¦æ‰“ä¸ŠpatchåŒ…ï¼Œç»´æŠ¤æˆæœ¬ç›¸å¯¹è¾ƒé«˜ã€‚</p>
<p>é‚£æœ‰æ²¡æœ‰å¯èƒ½ç”¨æ›´ä¾¿æ·çš„æ–¹å¼ï¼Œè®©Nginxå®ç°HTTP tunnelä»£ç†å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼</p>
<p>æˆ‘ä»¬çŸ¥é“Nginxå·²ç»é€šè¿‡<code>ngx_stream_core_module</code>, <code>ngx_stream_proxy_module</code>ç­‰æ¨¡å—è¿™æ¬¡äº†TCP/UDPçš„ä»£ç†ï¼ŒåŠ ä¸Š<a href="https://github.com/openresty/stream-lua-nginx-module" target="_blank" rel="external">openresty/stream-lua-nginx-module</a>çš„æ”¯æŒï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„å»å®ç°ä¸Šé¢çš„ä»£ç†åè®®ã€‚æ•´ä½“æ€è·¯å¦‚ä¸‹:</p>
<ol>
<li>åº”ç”¨nginxçš„streamèƒ½åŠ›ï¼ŒåšTCPçš„é€æ˜ä»£ç†</li>
<li>å¯¹äºåˆæ¬¡å»ºç«‹é“¾æ¥çš„è¯·æ±‚ï¼Œåšä¸€äº›åŒ…ä½“çš„åˆ†æï¼Œå¦‚æœæ˜¯CONNECTæ–¹å¼ï¼Œåˆ™ä»¥HTTPæ–¹å¼è¿”å›æ•°æ®ï¼Œæ„å»ºåå•†åè®®</li>
<li>åå•†ä¹‹åï¼Œåˆ™ä»¥TCPä»£ç†æ–¹å¼æä¾›æœåŠ¡å³å¯</li>
</ol>
<p>æ•´ä½“ä»£ç é…ç½®å¦‚ä¸‹:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="section">stream</span> &#123;</div><div class="line">	<span class="attribute">log_format</span> basic <span class="string">'<span class="variable">$remote_addr</span> [<span class="variable">$time_local</span>] '</span></div><div class="line">					 <span class="string">'<span class="variable">$protocol</span> <span class="variable">$status</span> <span class="variable">$bytes_sent</span> <span class="variable">$bytes_received</span> '</span></div><div class="line">					 <span class="string">'<span class="variable">$session_time</span>'</span>;</div><div class="line"></div><div class="line">    <span class="comment">## éœ€è¦å£°æ˜ä¸€ä¸ªå˜é‡ï¼Œæ³¨æ„è¯¥æŒ‡ä»¤åœ¨stream-lua-nginx-module-0.0.4ç‰ˆæœ¬ä»¥ä¸Šæ‰æœ‰</span></div><div class="line">    <span class="attribute">lua_add_variable</span> <span class="variable">$py_upstream</span>;</div><div class="line"></div><div class="line">    <span class="section">server</span> &#123;</div><div class="line">        <span class="attribute">listen</span> <span class="number">7070</span>;</div><div class="line"></div><div class="line">		<span class="attribute">access_log</span> logs/stream.log basic;</div><div class="line"></div><div class="line">        <span class="comment">## æŒ‡å®šdnsè§£æä»£ç†æœåŠ¡å™¨</span></div><div class="line">        <span class="attribute">resolver</span> <span class="number">8.8.8.8</span>;</div><div class="line"></div><div class="line">        <span class="comment">## preread_by_luaæ˜¯åœ¨æ¯æ¬¡è¿æ¥å»ºç«‹(TCP)æˆ–è€…æ•°æ®åŒ…(UDP)è¿‡æ¥è¢«è§¦å‘è°ƒç”¨</span></div><div class="line">        <span class="comment">## ä»£ç æ— å¤ªå¤šå®¹é”™æ€§ï¼Œä»…ç”¨äºæè¿°åŠŸèƒ½</span></div><div class="line">        <span class="section">preread_by_lua_block</span> &#123;</div><div class="line">            <span class="attribute">local</span> sock = assert(ngx.req.socket(<span class="literal">true</span>))</div><div class="line">            <span class="comment">## è·å–æ•°æ®</span></div><div class="line">            local data = sock:receive()</div><div class="line">            local len = string.len(data)</div><div class="line">            local connect = string.sub(data,<span class="number">1</span>, <span class="number">7</span>)</div><div class="line"></div><div class="line">            <span class="comment">## ngx.log(ngx.ERR, "data is: ", data)</span></div><div class="line">            <span class="comment">## åˆ¤æ–­å‰ç¼€æ˜¯ä¸æ˜¯"CONNECT"</span></div><div class="line">            if connect ~= <span class="string">"CONNECT"</span> then</div><div class="line">                ngx.log(ngx.ERR, <span class="string">"prefix scheme is connect, is: "</span>, connect)</div><div class="line">                ngx.exit()</div><div class="line">            end</div><div class="line"></div><div class="line">            <span class="comment">## è·å–è¦å‘é€çš„åŸŸåç«¯å£ä¿¡æ¯</span></div><div class="line">            local end_start,end_pos = string.find(data,<span class="string">" "</span>, <span class="number">9</span>)</div><div class="line">            local hostname = string.sub(data,<span class="number">9</span>, end_start - <span class="number">1</span>)</div><div class="line">            ngx.log(ngx.ERR, <span class="string">"hostname is: "</span>, hostname)</div><div class="line"></div><div class="line">            <span class="comment">## å›å¡«åˆ°py_upstreamå˜é‡ï¼Œä»¥ä¾¿proxy_passè°ƒç”¨</span></div><div class="line">            ngx.var.py_upstream = hostname</div><div class="line"></div><div class="line">            <span class="comment">## ä»¥æ­£å¸¸HTTPæ–¹å¼è¿”å›ï¼Œå®Œæˆåå•†</span></div><div class="line">            ngx.say(<span class="string">"HTTP/1.1 200 OK\r\n"</span>)</div><div class="line">            ngx.flush()</div><div class="line">            ngx.eof()</div><div class="line">        &#125;</div><div class="line">        <span class="comment">## æ­£å‘ä»£ç†</span></div><div class="line">        proxy_pass <span class="variable">$py_upstream</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦‚ä¸Šï¼Œå°±èƒ½å®Œæˆä¸€ä¸ª<code>http tunnel</code>åè®®çš„åŠŸèƒ½ã€‚</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><p><a href="http://jdebp.eu./FGA/web-browser-auto-proxy-configuration.html" target="_blank" rel="external">Automatic proxy HTTP server configuration in web browsers</a> : å¯¹PACåè®®ï¼Œå®ç°ï¼Œè§„åˆ™æœ‰è¯¦ç»†çš„æè¿°</p>
</li>
<li><p><a href="https://en.wikipedia.org/wiki/HTTP_tunnel" target="_blank" rel="external">HTTP tunnel</a> : å…·ä½“ä»‹ç»<code>HTTP tunnel</code>çš„æœºåˆ¶, ä¹Ÿå°±æ˜¯http proxyä»£ç†httpsè¯·æ±‚çš„å¸¸è§„æ–¹æ³•</p>
</li>
<li><p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/CONNECT" target="_blank" rel="external">MDN HTTP: CONNECT</a> : HTTP CONNECTæ–¹æ³•</p>
</li>
<li><p><a href="https://github.com/chobits/ngx_http_proxy_connect_module" target="_blank" rel="external">A forward proxy module for CONNECT request handling</a> : ä¸€ä¸ªNginx patch/æ‰©å±•, å¯ä»¥æ”¯æŒHTTP tunnelçš„<code>CONNECT</code>è¯·æ±‚ï¼Œ æ”¯æŒ<code>Forward Proxy</code></p>
</li>
</ul>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nginx-proxy/">nginx, proxy</a></li></ul>

      </footer>
    
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2018/04/18/20180415/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">weekly of 20180415&nbsp;<span>&gt;</span></div>
    </a>
  
</nav>

  
</article>






<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>


</section>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 shevacjs&nbsp;
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, theme by <a href="http://github.com/ppoffice">PPOffice</a>
    </div>
  </div>
</footer>
    
<script>
  var disqus_shortname = 'shevacjs-com';
  
  var disqus_url = 'http://shevacjs.com/2018/04/21/about_pac/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="/js/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
  </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>